<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.2',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="金融工程实验课上的一些笔记">
<meta name="keywords" content="笔记,编程">
<meta property="og:type" content="article">
<meta property="og:title" content="金融工程实验笔记">
<meta property="og:url" content="http://yoursite.com/2020/10/10/TSL/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="金融工程实验课上的一些笔记">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-12-10T08:18:35.219Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="金融工程实验笔记">
<meta name="twitter:description" content="金融工程实验课上的一些笔记">






  <link rel="canonical" href="http://yoursite.com/2020/10/10/TSL/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>金融工程实验笔记 | Hexo</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/10/TSL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wjqsteam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">金融工程实验笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-10-10 00:00:00" itemprop="dateCreated datePublished" datetime="2020-10-10T00:00:00+08:00">2020-10-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-12-10 16:18:35" itemprop="dateModified" datetime="2020-12-10T16:18:35+08:00">2020-12-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习/" itemprop="url" rel="index"><span itemprop="name">学习</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>金融工程实验课上的一些笔记</strong></p>
<a id="more"></a>
<hr>
<h1 id="TSL语言基础"><a href="#TSL语言基础" class="headerlink" title="TSL语言基础"></a>TSL语言基础</h1><p>1.面向对象的高级语言 2.类SQL语法 3.矩阵运算<br>系统执行到第一个<code>return</code>就返回,但是语法检查针对全篇<br>注释：1.行注释：<code>//</code> 和 <code>(* *)</code>  2.块注释 <code>{}</code><br>选中函数按<code>F1</code>查看函数说明<br><code>Ctrl+D</code>转换日期</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h3><p><code>整数</code>、<code>浮点数</code>（实数）、<code>字符串</code>（””或’’)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return &apos;&quot;万科&quot;SZ000002&apos;; // OK</span><br></pre></td></tr></table></figure>
<h3 id="特殊类型"><a href="#特殊类型" class="headerlink" title="特殊类型"></a>特殊类型</h3><p>空类型<code>nil</code>(类似于C语言中的空指针)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return nil;</span><br></pre></td></tr></table></figure>
<h3 id="没有布尔类型"><a href="#没有布尔类型" class="headerlink" title="没有布尔类型"></a>没有布尔类型</h3><p>非<code>0</code>非<code>nil</code>为真</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return false; //就是数字0</span><br><span class="line">return true; //就是数字1</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>需要事先定义。默认从<code>0</code>开始索引。  </p>
<p><code>length()</code>返回一维数组长度。<br><code>mSize(A,布尔值)</code>返回二维数组行列数（几行几列）若布尔值<br>为真则返回A的行列指标矩阵。<br><code>mRows(A,布尔值)</code>返回矩阵A的行数,布尔值为真返回A的行指标向量。<br><code>mCols(A,布尔值)</code>返回矩阵A的列数,布尔值为真返回A的列指标向量。</p>
<p>1.初始化一个空数组（在金融问题里常常不能事先定义）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:= array(); //初始化一个空数组</span><br><span class="line">a[1]:=2;a[0]:=3;a[7]:=5;</span><br><span class="line">a[4]:=&quot;abc&quot;;</span><br><span class="line">a[&quot;a&quot;]:=2; //字符串也可作为索引</span><br><span class="line">a[&quot;价格&quot;]:=22;</span><br><span class="line">return a;  //注意到数组内的数据类型可以不一样</span><br></pre></td></tr></table></figure>
<p>2.初始化一个非空数组（数组下标从0开始)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c:=1-&gt;10;</span><br><span class="line">c[3]:=&quot;abc&quot;; //可直接更改数组内元素</span><br><span class="line">return c;</span><br><span class="line">return array(1,2)-&gt;10; //1为数组第一个值,2为步长,10为终止值</span><br><span class="line">b:=array(2,4,&apos;abc&apos;,6);</span><br><span class="line">return b;</span><br></pre></td></tr></table></figure>
<p>3.多维数组：如矩阵可以认为是一个二维数组。<br>TSL语言中在一维数组中存放一维数组就是二维数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=array(array(1,2),array(3,4)); //a:=array((1.2),(3,4));</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<p>输出:  </p>
<table>
<thead>
<tr>
<th></th>
<th>0</th>
<th>1</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>4</td>
</tr>
</tbody>
</table>
<p><em>一维数组显示为列向量。二维数组内以行向量排列。</em>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b:=array((1,2,3,&apos;a&apos;)); //1*4的二维数组</span><br><span class="line">c:=array(1,2,3,&apos;a&apos;); //长度为4的一维数组</span><br><span class="line">return b[0,2]; // 结果为3</span><br></pre></td></tr></table></figure>
<p>4.字符串也是一个一维数组,但下标从<code>1</code>开始</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d:=&apos;abcd&apos;;</span><br><span class="line">return d[3]; // c</span><br></pre></td></tr></table></figure>
<p>5.允许混合维数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e:=array(1,3,array(2,4));</span><br><span class="line">return e[2];</span><br></pre></td></tr></table></figure>
<p>6.数组可以指定下标,支持字符串下标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e:=array(1:3,3:4); //下标1的位置为数字3.下标3的位置为数字4</span><br><span class="line">return e;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f:= array(1:(2:1,4:2),3:(2:3,&apos;a&apos;:4));</span><br><span class="line">return f;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<table>
<thead>
<tr>
<th></th>
<th>2</th>
<th>4</th>
<th>a</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td></td>
<td>4</td>
</tr>
</tbody>
</table>
<h3 id="日期类型——用浮点数表示日期和时间"><a href="#日期类型——用浮点数表示日期和时间" class="headerlink" title="日期类型——用浮点数表示日期和时间"></a>日期类型——用<code>浮点数</code>表示日期和时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return Date()-1 //返回昨天时间</span><br><span class="line">return Date() //返回当前系统时间（年月日）</span><br><span class="line">return 20200924.113124T //表示到秒的时间</span><br><span class="line">return inttodate(20200924) //</span><br><span class="line">return DateToStr(44980) //把整数日期转化为字符串</span><br><span class="line">return DatetimeToStr(44980.5) //把日期时间转化为字符串</span><br></pre></td></tr></table></figure>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p>赋值 <code>:=</code>  四则运算 <code>+、-、*、/</code> 乘方 <code>^</code> 取余 <code>mod</code>或<code>%</code> 整除 <code>div</code></p>
<h2 id="关系运算"><a href="#关系运算" class="headerlink" title="关系运算"></a>关系运算</h2><p><code>=</code> <code>&gt;</code> <code>&lt;</code> <code>&gt;=</code> <code>&lt;=</code>  <code>&lt;&gt;</code></p>
<h2 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h2><p><code>and</code> <code>or</code> <code>not</code></p>
<h2 id="运算优先级"><a href="#运算优先级" class="headerlink" title="运算优先级"></a>运算优先级</h2><p><code>not</code>运算的优先级高于高级运算,括号的优先级最高</p>
<h2 id="常量和变量：变量不需要预先定义-变量不区分大小写"><a href="#常量和变量：变量不需要预先定义-变量不区分大小写" class="headerlink" title="常量和变量：变量不需要预先定义,变量不区分大小写"></a>常量和变量：变量不需要预先定义,变量<code>不区分</code>大小写</h2><p>除了字符串里的字符外,都不区分大小写,函数和命令也是</p>
<h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><p><code>if ... then ... (else ...)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(); // 返回一个[0,1]之间的随机数</span><br><span class="line">echo a; // 程序运行中输出内容</span><br><span class="line">if a &gt; 0.5</span><br><span class="line">  then return &apos;a&gt;0.5&apos;</span><br><span class="line">  else return &apos;a&lt;=0.5&apos;</span><br></pre></td></tr></table></figure>
<h3 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a:=rand();</span><br><span class="line">echo a;</span><br><span class="line">if a &lt;= 1/3</span><br><span class="line">  then return &apos;a &lt;= 1/3&apos;</span><br><span class="line">else if a &lt;= 2/3</span><br><span class="line">  then return &apos;1/3&lt;a&lt;=2/3&apos;</span><br><span class="line">else return &apos;2/3&lt;a&lt;1&apos;</span><br></pre></td></tr></table></figure>
<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><p>四个中断命令:<br>1.<code>continue</code>跳过当前一次循环<br>2.<code>break</code>中断当前整个循环<br>3.<code>return</code>中断当前函数并返回值<br>4.<code>debugreturn</code>中断目前整个程序并返回值</p>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p><code>for i:= 初值 to 终值 step 步长 do begin ... end</code><br><code>for i:= 终值 downto 初值 do begin ... end</code></p>
<p>求和<code>1+2+3+...+100</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s:=0;</span><br><span class="line">for i:=1 to 100 do</span><br><span class="line">  begin</span><br><span class="line">    echo i;</span><br><span class="line">    s:=s+i;</span><br><span class="line">    echo &apos;s=&apos;,s;</span><br><span class="line">  end;</span><br><span class="line">return s;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a:=GetBK(&apos;创业板&apos;);</span><br><span class="line">result := array();</span><br><span class="line">for i:=0 to length(a)-1 do</span><br><span class="line">  begin</span><br><span class="line">    result[i,&apos;股票代码&apos;] := a[i];</span><br><span class="line">    result[i,&apos;股票名称&apos;] := StockName(a[i]);</span><br><span class="line">  end;</span><br><span class="line">return result;</span><br></pre></td></tr></table></figure>
<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><p><code>while ... do ...</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s:=0;i:=1;</span><br><span class="line">while i&lt;=100 do</span><br><span class="line">  begin</span><br><span class="line">    s:=s+i++;</span><br><span class="line">    //i++;</span><br><span class="line">  end</span><br><span class="line">return s;</span><br></pre></td></tr></table></figure>
<h3 id="repeat循环"><a href="#repeat循环" class="headerlink" title="repeat循环"></a>repeat循环</h3><p><code>repeat ... until ...</code> <em>至少执行一次循环</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s:=0; i:=1;</span><br><span class="line">repeat s:=s+i; i++; until i&gt;100; //repeat后多个语句不需加begin...end</span><br><span class="line">return s;</span><br></pre></td></tr></table></figure>
<p>求1到100之间不能被3整除的偶数和:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a := array();</span><br><span class="line">k :=0;</span><br><span class="line">for i:=1 to 100 do</span><br><span class="line">  begin</span><br><span class="line">    if (i mod 3 &lt;&gt; 0) and (i mod 2 = 0)</span><br><span class="line">        then</span><br><span class="line">          a[k] := i;</span><br><span class="line">          k++;</span><br><span class="line">  end;</span><br><span class="line">return sum(a);</span><br><span class="line">//return a;</span><br></pre></td></tr></table></figure>
<p>求1到100之间不能被3和5整除的偶数和:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a := array();</span><br><span class="line">k :=0;</span><br><span class="line">for i:=1 to 100 do</span><br><span class="line">  begin</span><br><span class="line">    if (i mod 3 &lt;&gt; 0) and (i mod 2 = 0) and (i mod 5 &lt;&gt; 0)</span><br><span class="line">        then</span><br><span class="line">          a[k] := i;</span><br><span class="line">          k++;</span><br><span class="line">  end;</span><br><span class="line">return sum(a);</span><br><span class="line">//return a;</span><br></pre></td></tr></table></figure>
<p><em>金融上一般把话反过来说</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if i mod 2 &lt;&gt; 0 then continue; // continue表示跳过这次循环</span><br><span class="line">if i mod 3=0 then continue;</span><br><span class="line">if i mod 5=0 then continue;</span><br></pre></td></tr></table></figure>
<h2 id="Case多条件分支"><a href="#Case多条件分支" class="headerlink" title="Case多条件分支"></a>Case多条件分支</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a:=round(10*rand()); // round四舍五入；返回一个0-10之间的随机整数</span><br><span class="line">case a of</span><br><span class="line">  1,3,5:b:=1;</span><br><span class="line">  0,2,4:b:=2;</span><br><span class="line">  &apos;ccc&apos;:b:=4;</span><br><span class="line">    else b:=3;</span><br><span class="line">end;</span><br><span class="line">return b;</span><br></pre></td></tr></table></figure>
<h2 id="矩阵-二维数组"><a href="#矩阵-二维数组" class="headerlink" title="矩阵(二维数组)"></a>矩阵(二维数组)</h2><p>按行存储。<br>矩阵初始化: 随机数<code>rand()</code>,恒为1<code>ones()</code>,单位阵<code>eye()</code>,零矩阵<code>zeros()</code>,空矩阵<code>nils()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">return rand(3,1); // 3*1随机矩阵</span><br><span class="line">return rand(3); // 一个一维随机向量</span><br><span class="line">return eye(3); // 3*3的单位矩阵</span><br><span class="line">return eye(3,6); // 多出部分填充为0</span><br><span class="line">return zeros(3,4);</span><br><span class="line">return nils(3,4); // 矩阵的每一个元素都是nil</span><br><span class="line">return rand(array(1,3),array(&apos;a&apos;,&apos;b&apos;)); // 指定矩阵的行标列表</span><br><span class="line">return rand(array(1,2)-&gt;10,array(2,&apos;a&apos;,&apos;b&apos;)); // 行标为1到10,步距为2的数组</span><br><span class="line">return rand(3,4,array(&apos;normal&apos;,0,1)); // 矩阵数据来自均值为0方差为1的正态分布</span><br><span class="line">// 查看rand()帮助文档有更详细的说明</span><br><span class="line">return randn(均值,方差,m,n); // m行n列服从正态分布的矩阵</span><br></pre></td></tr></table></figure>
<h3 id="矩阵算符"><a href="#矩阵算符" class="headerlink" title="矩阵算符"></a>矩阵算符</h3><ol>
<li>对应元素运算(点运算):<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>\</code>, <code>^</code>, <code>mod</code>或<code>%</code>, <code>div</code>, <code>++</code>, <code>--</code><br>没有对应元素则对应位置不做运算。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">b:=ones(3,3);</span><br><span class="line">c:=eye(3);</span><br><span class="line">e:=array((1,3),(2,4));f:=array((2,4),(3,1));g:=ones(2,2);</span><br><span class="line">return b+e;</span><br><span class="line">return 1/2; // 0.5</span><br><span class="line">return 1\2; // 2</span><br><span class="line">return g/e; // e\g</span><br><span class="line">return (c+2*b)^2;</span><br><span class="line">// ++a与a++是不同的</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>矩阵乘除法: <code>:*</code> , <code>:\</code> , <code>:/</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(3,3);</span><br><span class="line">return a:/a; // 单位阵</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>矩阵的乘方: <code>:^</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(3,3);</span><br><span class="line">return a:^2;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>矩阵的转置: <code>`a</code></li>
</ol>
<p>转置将一维向量转化为矩阵</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h:=1-&gt;5;</span><br><span class="line">return `h; // 一维变二维</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>求逆矩阵: <code>!a</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return !a;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>矩阵对应元素的判断: <code>.&gt;</code>, <code>.&gt;=</code>, <code>.&lt;</code>, <code>.&lt;=</code>, <code>.=</code>, <code>.&lt;&gt;</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return e=f; //两个矩阵整体是否相等,返回值0或1</span><br><span class="line">return e.=f; // 两个矩阵对应元素是否相等,返回一个0-1矩阵</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>支持等于运算符: <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>, <code>^=</code>, <code>:*=</code>, <code>:/=</code>, <code>:^=</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e:=array((2,3),(2,4));</span><br><span class="line">e+=2; // e:=+2</span><br><span class="line">e:*=a; // e:=e:*a;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>绝大多数基础数学函数支持矩阵运算: <code>abs()</code>, <code>sqr()</code>, <code>sqrt()</code>,<br><code>sin()</code>, <code>cos()</code>, <code>tan()</code>,<br><code>exp()</code>, <code>ln()</code>, <code>log(对数,底数)</code>,<code>log10()</code>, <code>log2()</code><br>舍入函数: 银行家四舍五入(舍入树为5(且为最后一位数)时舍入到最近的偶数)<code>round()</code>,<br>四舍五入<code>SimpleRound()</code>,<br>向下取整<code>Floor</code>, 向上取整<code>Ceil</code>,<code>roundto</code>, <code>SimpleRoundTo</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">round(2.5); // 2</span><br><span class="line">round(3.5); // 4</span><br><span class="line">roundto(2.21,-1); // 2.2 舍入到第几位(-1 小数点后一位)</span><br><span class="line">roundto(1251,2); //1300 舍入到从前往后第二位,和50比,以此类推</span><br></pre></td></tr></table></figure>
<h3 id="取子矩阵-切片"><a href="#取子矩阵-切片" class="headerlink" title="取子矩阵(切片)"></a>取子矩阵(切片)</h3><p>一维数组同理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">aa:=array();</span><br><span class="line">  for i:=0 to 5 do</span><br><span class="line">    for j:=0 to 5 do</span><br><span class="line">      aa[i,j]:=i*10+j;</span><br><span class="line">return aa[2:4,3:5];</span><br><span class="line">return aa[:,2]; // 取第二列</span><br><span class="line">return aa[2]; // 第二行,一维向量</span><br><span class="line">return aa[2:2]; // 第二行,二维行向量</span><br><span class="line">return aa[:,2:2]; // 第二列,二维列向量</span><br><span class="line">return aa[:,array(0,2,4)]; // 取0,2,4列构成的子矩阵</span><br></pre></td></tr></table></figure>
<p>支持字符指标数组和矩阵</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c:=array((&apos;a&apos;:1,&apos;b&apos;:2,&apos;c&apos;:3,&apos;d&apos;:4),(&apos;a&apos;:1,&apos;b&apos;:2,&apos;c&apos;:3,&apos;d&apos;:4));</span><br><span class="line">return c[:,&apos;a&apos;];</span><br></pre></td></tr></table></figure>
<h3 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h3><ol>
<li>上下连接函数<code>union</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a := rand(2,3);</span><br><span class="line">b:=eye(3); // 上下连接的两个矩阵维度不一定要相同</span><br><span class="line">c:=a union b; // 可以连接两个一维向量</span><br><span class="line">return c;</span><br></pre></td></tr></table></figure>
<p>下面也是一种连接方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=eye(3);b:=rand(3);</span><br><span class="line">a[mRows(a)]:=b;</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>左右连接函数<code>|</code>和<code>:|</code></li>
</ol>
<p>会向前合并相同列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=ones(4,3);</span><br><span class="line">b:=rand(5,3);</span><br><span class="line">return a|b;</span><br><span class="line">return a:|b; // 避免后面矩阵多出的行前移</span><br><span class="line">return array(1,2) | array(3,4); // 左右连接两个一维向量为一个两列的矩阵</span><br></pre></td></tr></table></figure>
<p>左右连接运算优先级高于+-运算</p>
<h3 id="矩阵的查找和遍历"><a href="#矩阵的查找和遍历" class="headerlink" title="矩阵的查找和遍历"></a>矩阵的查找和遍历</h3><p>练习：用循环查找a中大于0.5的元素的位置和值,并用一个数组返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">a :=rand(5,4);</span><br><span class="line">b:=array();</span><br><span class="line">m:=0;</span><br><span class="line">for i:=0 to mRows(a)-1 do</span><br><span class="line">  for j:=0 to mCols(a)-1 do</span><br><span class="line">    begin</span><br><span class="line">      if a[i,j] &gt; 0.5</span><br><span class="line">        then</span><br><span class="line">          begin</span><br><span class="line">          // b[k] := array(i,j,a[i,j]);</span><br><span class="line">           b[m,&apos;行&apos;]:=i;</span><br><span class="line">           b[m,&apos;列&apos;]:=j;</span><br><span class="line">           b[m,&apos;数值&apos;]:=a[i,j];</span><br><span class="line">           m++;</span><br><span class="line">          end</span><br><span class="line">    end</span><br><span class="line">return b;</span><br></pre></td></tr></table></figure>
<ol>
<li>矩阵查找<code>MFind(A,判断表达式,布尔值,值)</code></li>
</ol>
<p>返回矩阵A中满足表达式的元素位置,当布尔值为真时再多返回该元素的值,将A中查找到的替换为某值(字符串或数字)。<br>表达式关键字：元素值<code>mcell</code>,行下标<code>mrow</code>,列下标<code>mcol</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(5,4);</span><br><span class="line">return MFind(a,mcell&gt;0.5,true);</span><br><span class="line">return MFind(a,mecell&gt;0.5 and mrow&gt;2,true);</span><br><span class="line">return MFfind(a); // 返回为真的值的行列数</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>二维矩阵遍历<code>::</code></li>
</ol>
<p>遍历关键字：当前单元格值mcell,当前行下标mrow,当前列下标mcol</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=randn(5,4);</span><br><span class="line">a::begin</span><br><span class="line">  if mcell:=mrow*mcol;</span><br><span class="line">  end</span><br><span class="line">return a</span><br></pre></td></tr></table></figure>
<p>支持对子矩阵遍历：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(7,9);</span><br><span class="line">a[2:4,3:5]::begin</span><br><span class="line">  mecell := (mrow+1)*(mcol+1);</span><br><span class="line">  end</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<p>若遍历只是对单元格元素赋值,则有如下简写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=eye(4,4);</span><br><span class="line">a[1:2,3:4]::=mcol*mrow;</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=getbk(&apos;创业板&apos;);</span><br><span class="line">b:=a;</span><br><span class="line">a::=StockName(mcell);</span><br><span class="line">return b|a;</span><br></pre></td></tr></table></figure>
<h3 id="指标转换reindex-数组-dim1-dim2"><a href="#指标转换reindex-数组-dim1-dim2" class="headerlink" title="指标转换reindex(数组,dim1,dim2,...)"></a>指标转换<code>reindex(数组,dim1,dim2,...)</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(2,3);</span><br><span class="line">reindex(a,array(0:&apos;a&apos;,1:&apos;b&apos;),array(&apos;c&apos;,&apos;d&apos;,&apos;e&apos;)); // 可指定改哪里 0-&gt;a,1-&gt;b</span><br><span class="line">reindex(a,nil,array(&apos;c&apos;,&apos;d&apos;,&apos;e&apos;))); //只改列标</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:=getbk(&apos;创业板&apos;);</span><br><span class="line">b:=a;</span><br><span class="line">a::=StockName(mcell);</span><br><span class="line">c:=b|a;</span><br><span class="line">reindex(c,nil,array(&apos;代码&apos;,&apos;名称&apos;));</span><br><span class="line">return c;</span><br></pre></td></tr></table></figure>
<p>修改后行列指标会按字典排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=eye(5);</span><br><span class="line">a::=mrow*mcol;</span><br><span class="line">reindex(a,array(1:3,3:1)); // 把a的1行到3行对调</span><br><span class="line">reindex(a,nil,array(3:nil)); //删除第3列</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<h3 id="删除矩阵行列的函数"><a href="#删除矩阵行列的函数" class="headerlink" title="删除矩阵行列的函数"></a>删除矩阵行列的函数</h3><p><code>deleteindex()</code>   <code>deletefield()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=eye(4);</span><br><span class="line">deleteindex(a,&apos;b&apos;);</span><br><span class="line">reindex(a,array(2:nil)); //注意和deleteindex方法的区别</span><br><span class="line">//deleteindex(a,2); //deleteindex向前补,reindex直接删除了整个第二行</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<h3 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h3><p><code>in</code>,并集<code>union2</code>,交集<code>intersect</code>,差集<code>minus</code>,对称差集<code>outersect</code><br>用数组表示集合<br>集合里面没有重复元素,可以利用集合运算去除重复元素  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=array(1,1,3,3,6,6);</span><br><span class="line">return a union2 array(); // 去重</span><br><span class="line">return a minus array() // 去重</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=0-&gt;9;b:=5-&gt;11;</span><br><span class="line">return a outersect b;</span><br><span class="line">return a minus b;</span><br><span class="line">return a intersect b;</span><br></pre></td></tr></table></figure>
<p>支持二维数组：完全相同的两行为重复元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=array((1,3),(5,7));</span><br><span class="line">return 1 in a;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=array((1,3),(5,7));</span><br><span class="line">b:=array((1,2),(2,4));</span><br><span class="line">return a union2 b;</span><br></pre></td></tr></table></figure>
<p>去除矩阵内的相同列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=array((1,1),(3,3));</span><br><span class="line">b:= `a minus array();</span><br><span class="line">return b;</span><br></pre></td></tr></table></figure>
<h2 id="函数对于异常输入的处理"><a href="#函数对于异常输入的处理" class="headerlink" title="函数对于异常输入的处理"></a>函数对于异常输入的处理</h2><p>函数后面多加一个参数<code>1</code>表示接受空值,参数为<code>2</code>表示接受空值和字符串,<br>参数为<code>3</code>表示将出错的部分用之后的参数替代<br>TSL中的大多数基础函数都支持该类处理异常输入方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:=array(1,-1,nil,-2);</span><br><span class="line">b:=array(1,-1,nil,&apos;abc&apos;);</span><br><span class="line">//return abs(a); // 报错</span><br><span class="line">return abs(a,1); // ok</span><br><span class="line">return abs(b,2); // ok</span><br><span class="line">return abs(a,3,&apos;error&apos;); // ok</span><br></pre></td></tr></table></figure>
<h2 id="统计函数"><a href="#统计函数" class="headerlink" title="统计函数"></a>统计函数</h2><p>均值<code>mean()</code>,方差<code>Variance()</code>,标准差<code>StdDev()</code>,求和<code>Sum()</code>等  </p>
<p>详见：天软金融分析.NET函数大全 &gt; 函数大全 &gt; 一般统计量  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(5,4);</span><br><span class="line">return Mean(a); // 按列求平均</span><br><span class="line">b:=a union ``Mean(a); // 平均值附到a的最后一行</span><br><span class="line">reindex(b,array(length(a):&apos;Mean&apos;));</span><br><span class="line">return b;</span><br></pre></td></tr></table></figure>
<p>统计函数的第一个参数默认值为<code>0</code>（按列操作）,<code>1</code>表示按行操作<br>第二个参数为移动计算的步长,<code>0</code>不移动<br>第三个参数为字段的筛选,对第几行(列)操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:= rand(4,3);</span><br><span class="line">return mean(a,1);</span><br><span class="line">return a | nils(4,1) | mean(a,0,2); // 按列求移动平均,步长为2</span><br><span class="line">return mean(a,0,0,array(0,2)); // 对第0列和第2列的计算</span><br></pre></td></tr></table></figure>
<h1 id="SQL-结构化查询语言-Structual-Query-Language"><a href="#SQL-结构化查询语言-Structual-Query-Language" class="headerlink" title="SQL-结构化查询语言(Structual Query Language)"></a>SQL-结构化查询语言(Structual Query Language)</h1><p>一种数据库查询和程序设计语言,用于存取数据以及查询,更新和管理关系数据库系统<br>关系型数据库：以记录为存储单位（行存储）,以字段(列)保存每一个属性<br>基本操作：查询、插入、更新、删除<br>额外需求：排序、聚集(计数<code>count</code>,求和<code>sum</code>,求平均<code>avg</code>,最小<code>min</code>,最大<code>max</code>)、<br>多结果集（笛卡尔积、多表操作）操作<code>join</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(50,10); // 矩阵的列表就是字段名</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">end</span> ; // 相当于return a</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],[<span class="number">2</span>] <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return a[:,array(0,2)]; // 和上一行有什么区别？</span><br><span class="line">return <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">to</span> <span class="number">3</span>, [<span class="number">6</span>] <span class="keyword">from</span> a <span class="keyword">end</span>; // 1,2,3,6列</span><br><span class="line">return <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">to</span> <span class="number">3</span>, [<span class="number">6</span>] <span class="keyword">as</span> <span class="string">'第六'</span>, [<span class="number">8</span>] <span class="keyword">from</span> a <span class="keyword">end</span>; // 可以改名</span><br></pre></td></tr></table></figure>
<p><code>order by</code> : 排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(5,3);</span><br><span class="line">b:=<span class="keyword">select</span> [<span class="number">1</span>] <span class="keyword">as</span> <span class="string">'1列'</span>, [<span class="number">2</span>] <span class="keyword">as</span> <span class="string">'2列'</span></span><br><span class="line">              <span class="keyword">from</span> a <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">0</span>] <span class="keyword">asc</span> <span class="keyword">end</span>; // 从小到大asc,从大到小desc</span><br><span class="line">return a | nils(5,1) | b;</span><br></pre></td></tr></table></figure>
<p>多字段排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a := rand(10,4);</span><br><span class="line">a[:,0] := a[:,0] * 10 div 3;</span><br><span class="line">a[:,1] := a[:,1] * 10 div 2;</span><br><span class="line">b := <span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">0</span>] <span class="keyword">desc</span>,[<span class="number">1</span>],[<span class="number">2</span>] <span class="keyword">end</span>;</span><br><span class="line">return a | nils(10,1) | b;</span><br></pre></td></tr></table></figure>
<p><code>drange(m to n)</code> : 输出查询结果中m到n的行,负数为倒数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10,3);</span><br><span class="line">b:=<span class="keyword">select</span> drange(<span class="number">0</span> <span class="keyword">to</span> <span class="number">2</span>) [<span class="number">0</span>] <span class="keyword">as</span> <span class="string">'0列'</span>, [<span class="number">2</span>] <span class="keyword">as</span> <span class="string">'2列'</span></span><br><span class="line">              <span class="keyword">from</span> a <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">0</span>] <span class="keyword">asc</span> <span class="keyword">end</span>;</span><br><span class="line">c:=<span class="keyword">select</span> drange(<span class="number">0</span> <span class="keyword">to</span> <span class="number">2</span>) * <span class="keyword">from</span> a <span class="keyword">end</span>; // 未排序的情况</span><br><span class="line">return a | nils(10,1) | b;</span><br></pre></td></tr></table></figure>
<p><code>where + 判断条件</code> : 条件查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">d:= <span class="keyword">select</span> drange(<span class="number">-3</span> <span class="keyword">to</span> <span class="number">-1</span>) [<span class="number">0</span>] <span class="keyword">as</span> <span class="string">'0列'</span>, [<span class="number">2</span>] <span class="keyword">as</span> <span class="string">'2列'</span></span><br><span class="line">          <span class="keyword">from</span> a</span><br><span class="line">          <span class="keyword">where</span> ([<span class="number">0</span>]&gt;<span class="number">0.5</span> <span class="keyword">and</span> [<span class="number">1</span>]&gt;<span class="number">0.5</span>) // 先<span class="keyword">where</span>再<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">          <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">1</span>] <span class="keyword">desc</span></span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">return a | nils(10,1) | d;</span><br></pre></td></tr></table></figure>
<p><code>drange(m of n)</code> : 结果分成n份,取第m份</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a := rand(10,3);</span><br><span class="line">a[:,0] := 0-&gt;9;</span><br><span class="line">b:= <span class="keyword">select</span> drange(<span class="number">2</span> <span class="keyword">of</span> <span class="number">5</span>) * <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return a | nils(length(a),1) | b;</span><br></pre></td></tr></table></figure>
<p><code>distinct</code> : 去重</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a := array((1,2,3),(1,2,3),(1,4,3));</span><br><span class="line">return <span class="keyword">select</span> <span class="keyword">distinct</span> * <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> <span class="keyword">distinct</span> [<span class="number">0</span>],[<span class="number">2</span>] <span class="keyword">from</span> a <span class="keyword">end</span>; // 选取0,2字段去重后的结果</span><br></pre></td></tr></table></figure>
<p><code>select</code>可以结合函数运算</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a := rand(3,4);</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],<span class="keyword">round</span>(<span class="number">10</span> * [<span class="number">1</span>]),[<span class="number">0</span>]+[<span class="number">1</span>] <span class="keyword">as</span> <span class="string">'sum'</span> <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],[<span class="number">1</span>],b:=<span class="keyword">round</span>(<span class="number">10</span>*[<span class="number">1</span>]) <span class="keyword">as</span> nil, // 该字段不出现在结果中</span><br><span class="line">                      b+[<span class="number">1</span>],b+[<span class="number">0</span>] <span class="keyword">as</span> <span class="string">'sum'</span> // 给中间过程取名为b</span><br><span class="line">                      <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p><code>thisrowindex</code> : 返回结果集中记录在原先表中的序号<br><code>thisorder</code> : 返回结果集中排序的序号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a := rand(10,3);</span><br><span class="line">return <span class="keyword">select</span> *, thisrowindex,thisorder <span class="keyword">from</span> a <span class="keyword">where</span> [<span class="number">2</span>] &gt; <span class="number">0.5</span> <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">1</span>] <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p><code>thisrow</code> : 返回当前行的数据。对于一维数组要用这个。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a := rand(10);</span><br><span class="line">return <span class="keyword">select</span> thisrow <span class="keyword">from</span> a <span class="keyword">where</span> thisrow &gt; <span class="number">0.5</span> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p><code>in</code> : 过滤运算</p>
<p>类似于集合运算,但不去除重复元素</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=array(1,3,3,5,9);</span><br><span class="line">b:=1-&gt;6;</span><br><span class="line">return <span class="keyword">select</span> thisrow <span class="keyword">from</span> a <span class="keyword">where</span> thisrow <span class="keyword">in</span> b <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>否定 : <code>not</code>,需要加括号使用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10,3);</span><br><span class="line">a[:,1]:=a[:,1]*10 div 2;</span><br><span class="line">b:=2-&gt;4;</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">where</span> <span class="keyword">not</span> ([<span class="number">1</span>] <span class="keyword">in</span> b) <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h2 id="聚集函数"><a href="#聚集函数" class="headerlink" title="聚集函数"></a>聚集函数</h2><p>聚集表示类之间的关系,是整体与部分的关系,常用聚集函数有<code>Avgof()</code>均值、<code>maxof</code>、<code>sumof</code><br>、<code>Countof()</code>计数、<code>CountIfof</code>条件计数、<code>stdevof()</code>标准差、<code>varof</code>方差。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(20,5);</span><br><span class="line">return <span class="keyword">select</span> Avgof([<span class="number">0</span>]) <span class="keyword">as</span> <span class="string">'avg'</span> <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> Avgof([<span class="number">0</span>]) <span class="keyword">from</span> a <span class="keyword">where</span> [<span class="number">0</span>]&gt;<span class="number">0.5</span> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>group by</code> : 分组聚合</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(50,5);</span><br><span class="line">a[:,0]:=a[:,0]*100 mod 5;</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],Avgof([<span class="number">1</span>]) <span class="keyword">from</span> a</span><br><span class="line">                  <span class="keyword">where</span> [<span class="number">0</span>]&gt;<span class="number">1</span></span><br><span class="line">                  <span class="keyword">group</span> <span class="keyword">by</span> [<span class="number">0</span>]</span><br><span class="line">                  <span class="keyword">having</span> Avgof([<span class="number">1</span>]) &lt;<span class="number">0.6</span> // 对聚集结果的筛选</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">0</span>] <span class="keyword">end</span>; // 先分组再排序</span><br><span class="line">                  // 以上关键字的次序不能颠倒</span><br></pre></td></tr></table></figure>
<p>在主函数末尾定义子函数:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function lambda(x):</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> x &lt; <span class="number">0.25</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">if</span> x &lt; <span class="number">0.5</span>  <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">  <span class="keyword">if</span> x &lt; <span class="number">0.75</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">select</span> maxof([<span class="number">3</span>]),CountOf(),</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> thisgroup <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">from</span> a <span class="keyword">group</span> <span class="keyword">by</span> lambda([<span class="number">0</span>]) <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>vselect</code> : 返回一个标量<br><code>sselect</code> : 返回一个一维向量</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(20,5);</span><br><span class="line">return a:|sselect [0],[1] from a <span class="keyword">end</span>;</span><br><span class="line">return vselect maxof[1] from a <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>group by</code>支持按多字段进行分组</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(50,5);</span><br><span class="line">a[:,0]:=a[:,0]*100 mod 5;</span><br><span class="line">a[:,1]:=a[:,1]*100 mod 5;</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],[<span class="number">1</span>],Avgof([<span class="number">2</span>]),</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> thisgroup <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">from</span> a</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> [<span class="number">0</span>],[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> [<span class="number">0</span>],[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>实例:<br>选股就是按照一定财务指标和技术指标对股票进行筛选</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">EndT:=today();</span><br><span class="line">rdate:= 20200930; //EndT和rdate可以通过设置函数参数方法获取</span><br><span class="line">SetSysParam(pn_date(),endt);</span><br><span class="line">stks:=GetBK("创业板");</span><br><span class="line">a:=array();</span><br><span class="line">for i:=0 to length(stks)-1 <span class="keyword">do</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   stockid:=stks[i];</span><br><span class="line">   setsysparam(pn_stock(), stockid);</span><br><span class="line">   a[i]['代码']:=stockid;</span><br><span class="line">   a[i]['名称']:=stockname(stockid);</span><br><span class="line">   a[i]['每股收益']:=ReportOfAll(9900000,rdate);</span><br><span class="line">   a[i]['净资产收益率(%)']:=ReportofAll(9900100,rdate);</span><br><span class="line">   a[i]['收盘价']:=close();</span><br><span class="line">   a[i]['成交金额']:=amount();</span><br><span class="line">   //a[i]['MACD']:=MACD_MACD_v(12,26,9);</span><br><span class="line"> //MACD需要实时计算,很耗时间</span><br><span class="line">   a[i]['市盈率']:=StockPE(EndT);</span><br><span class="line"> a[i]['今日涨幅(%)']:=StockZf3();</span><br><span class="line">   a[i]['今年涨幅(%)']:= StockZf(20180101T,endt);</span><br><span class="line">   a[i]['市值(万)']:=StockTotalValue3();</span><br><span class="line">   a[i]['行业名称']:=base(10029);</span><br><span class="line">   a[i]['行业代码']:=base(10035);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">select</span> drange(<span class="number">0</span> <span class="keyword">to</span> <span class="number">4</span>) [<span class="string">'行业名称'</span>], sumof([<span class="string">'成交金额'</span>])/<span class="number">10</span>^<span class="number">8</span> <span class="keyword">as</span> <span class="string">'行业成交金额(亿)'</span></span><br><span class="line">       <span class="keyword">from</span> a</span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'行业名称'</span>]</span><br><span class="line">       <span class="keyword">order</span> <span class="keyword">by</span> sumof([<span class="string">'成交金额'</span>]) <span class="keyword">desc</span></span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>计算创业板估值按行业分类今年平均涨幅最高的前十个行业:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aa:=  <span class="keyword">select</span> drange (<span class="number">0</span> <span class="keyword">to</span> <span class="number">9</span>) [<span class="string">'行业名称'</span>], Avgof([<span class="string">'今年涨幅(%)'</span>]) <span class="keyword">as</span> <span class="string">'今年平均涨幅'</span></span><br><span class="line">      <span class="keyword">from</span> a</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'行业名称'</span>]</span><br><span class="line">      <span class="keyword">order</span> <span class="keyword">by</span> Avgof([<span class="string">'今年涨幅(%)'</span>]) <span class="keyword">desc</span></span><br><span class="line">      <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>统计每个行业中今日涨幅大于0的股票个数及其在该行业中占比:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bb:= <span class="keyword">select</span> [<span class="string">'行业名称'</span>], k:=CountifOf([<span class="string">'今日涨幅(%)'</span>]&gt;<span class="number">0</span>) <span class="keyword">as</span> <span class="string">'涨幅大于0股票个数'</span>,</span><br><span class="line">      k / countof() * <span class="number">100</span> <span class="keyword">as</span> <span class="string">'其所占比例(%)'</span></span><br><span class="line">      <span class="keyword">from</span> a</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'行业名称'</span>]</span><br><span class="line">      <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>统计每只股票成交金额占创业板总成交金额的百分比:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cc:= <span class="keyword">select</span> [<span class="string">'名称'</span>],[<span class="string">'成交金额'</span>]/<span class="number">10</span>^<span class="number">8</span> <span class="keyword">as</span> <span class="string">'成交金额(亿)'</span>,</span><br><span class="line">            [<span class="string">'成交金额'</span>] / sumof([<span class="string">'成交金额'</span>]) *<span class="number">100</span> <span class="keyword">as</span> <span class="string">'百分比(%)'</span></span><br><span class="line">            <span class="keyword">from</span> a</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">return cc;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>聚集函数的参数</li>
</ol>
<p>第一个参数：条件聚集</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(20,5);</span><br><span class="line">return <span class="keyword">select</span> Avgof([<span class="number">0</span>],[<span class="number">0</span>] &gt; <span class="number">0.5</span>),Avgof([<span class="number">0</span>],[<span class="number">0</span>]&lt;=<span class="number">0.5</span>)</span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> Avgof([<span class="number">0</span>]) <span class="keyword">from</span> a <span class="keyword">group</span> <span class="keyword">by</span> [<span class="number">0</span>]&gt;<span class="number">0.5</span> <span class="keyword">end</span>; // 注意区别</span><br></pre></td></tr></table></figure>
<p>第二个参数：移动计算</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],Avgof([<span class="number">0</span>],<span class="literal">true</span>,<span class="number">2</span>),</span><br><span class="line">       Avgof([<span class="number">0</span>],[<span class="number">0</span>]&gt;<span class="number">0.5</span>,<span class="number">2</span>) // 和最近的符合条件的数字进行移动计算</span><br><span class="line">       <span class="keyword">from</span> a</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>selectopt(64)</code>表示移动优先于条件</li>
</ol>
<p>略</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),'SZ000002');</span><br><span class="line">a:= Nday(100,'Date',DateToStr(sp_time()),</span><br><span class="line">        'Open',open(),'Close',close());</span><br><span class="line">return <span class="keyword">select</span> *, Avgof([<span class="string">'Close'</span>],<span class="literal">true</span>,<span class="number">10</span>) <span class="keyword">as</span> <span class="string">'MA10'</span>,</span><br><span class="line">       Avgof([<span class="string">'Close'</span>],[<span class="string">'Close'</span>]&gt;[<span class="string">'Open'</span>],<span class="number">10</span>) <span class="keyword">as</span> <span class="string">'condMA10'</span></span><br><span class="line">       <span class="keyword">from</span> a</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><code>refof</code> : 返回上一行的值  </li>
</ol>
<p><code>selectopt(64)</code>对该聚集函数不起作用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10,5);</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">0</span>],refof([<span class="number">0</span>],<span class="number">1</span>,[<span class="number">0</span>]&gt;<span class="number">0.5</span>),refof([<span class="number">0</span>],<span class="number">2</span>) // 返回上一行,返回上两行</span><br><span class="line">       <span class="keyword">from</span> a</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>用于计算涨幅的例子:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),'SZ000002');</span><br><span class="line">a:= Nday(100,'日期',DateToStr(sp_time()),</span><br><span class="line">        '开盘价',open(),'收盘价',close());</span><br><span class="line">return <span class="keyword">select</span> *, k:=refof([<span class="string">'收盘价'</span>],<span class="number">1</span>) <span class="keyword">as</span> <span class="string">'昨收'</span>,</span><br><span class="line">              ([<span class="string">'收盘价'</span>]-k)/k * <span class="number">100</span> <span class="keyword">as</span> <span class="string">'涨幅(%)'</span></span><br><span class="line">              <span class="keyword">from</span> a</span><br><span class="line">              <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>聚集函数支持去重操作</li>
</ol>
<p>在聚集函数中的字段前加<code>distinct</code>,表示只对该字段下不同的值做聚集操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=array((1,2),(1,1),(3,2));</span><br><span class="line">return <span class="keyword">select</span> Avgof([<span class="number">0</span>]),Avgof(<span class="keyword">distinct</span> [<span class="number">0</span>]) <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>多字段聚集<br>支持条件聚集<code>aggvalue</code><br>注意和注释<code>(* *)</code>区分,<code>*</code>前有空格</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:= rand(10,5);</span><br><span class="line">return mean(a); // 一维数组</span><br><span class="line">return <span class="keyword">select</span> selectopt(<span class="number">16</span>) Avgof( *) <span class="keyword">from</span> a <span class="keyword">end</span>; // 二维数组</span><br><span class="line">// 多字段聚集时selectopt(16)会让返回的结果保持原先的字段名</span><br><span class="line">// 单字段聚集时selectopt(32)会让返回的结果保持原先的字段名</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),'SZ000002');</span><br><span class="line">a:= Nday(100,'日期',DateToStr(sp_time()),</span><br><span class="line">        '开盘价',open(),'收盘价',close());</span><br><span class="line">return <span class="keyword">select</span> selectopt(<span class="number">16</span>) Avgof(<span class="number">1</span> <span class="keyword">to</span> <span class="number">2</span>) <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10,5);</span><br><span class="line">return <span class="keyword">select</span> Avgof( *, aggvalue &gt; <span class="number">0.5</span>) <span class="keyword">from</span> a <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h2 id="类SQL语法的其他操作"><a href="#类SQL语法的其他操作" class="headerlink" title="类SQL语法的其他操作"></a>类SQL语法的其他操作</h2><ol>
<li><code>delete</code>删除</li>
</ol>
<p>删除满足<code>where</code>后条件的记录(行),结尾不同加<code>end</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10,5);</span><br><span class="line">a[:,0]:=(1-&gt;10) div 2;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> a <span class="keyword">where</span> [<span class="number">0</span>]=<span class="number">2</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> a <span class="keyword">where</span> <span class="keyword">not</span> ([<span class="number">0</span>] <span class="keyword">in</span> <span class="built_in">array</span>(<span class="number">1</span>,<span class="number">3</span>));</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>insert</code>插入</li>
</ol>
<p>插入到表尾</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(5,5);</span><br><span class="line">b:=ones(5,5);</span><br><span class="line"><span class="keyword">insert</span> a b; // a:= a union b 或 a&amp;=b</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> a <span class="keyword">values</span>(<span class="number">1</span>,nil,<span class="number">3</span>,<span class="number">4</span>); // 插入空值</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> a insertfields([<span class="number">1</span>],[<span class="number">4</span>]) <span class="keyword">values</span>(<span class="number">5</span>,<span class="number">9</span>);</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>update</code>更新</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(5,5);</span><br><span class="line"><span class="keyword">update</span> a <span class="keyword">set</span> [<span class="number">0</span>] = <span class="number">123</span>, [<span class="number">1</span>]=[<span class="number">1</span>] * <span class="number">100</span>+ <span class="keyword">ln</span>([<span class="number">2</span>]) <span class="keyword">where</span> [<span class="number">1</span>]&lt;<span class="number">0.5</span> <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">update</span> a <span class="keyword">set</span> [<span class="number">1</span>] = <span class="number">123</span> <span class="keyword">where</span> [<span class="number">0</span>]&lt;<span class="number">0.5</span> <span class="keyword">end</span>;</span><br><span class="line">return a;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><code>join</code>多表连接</li>
</ol>
<p>根据<code>on</code>后的条件将两张表连接为一张总表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a:=array();</span><br><span class="line">a[0:4,'学号']:=1-&gt;5;</span><br><span class="line">a[0:4,'姓名']:= array('a','b','c','d','e');</span><br><span class="line">b:=array();</span><br><span class="line">b[0:4,'学号']:=1-&gt;5;</span><br><span class="line">b[0:4,'成绩']:=array(90,80,85,95,100);</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">1</span>].*, [<span class="number">2</span>].[<span class="string">'成绩'</span>]  // <span class="keyword">return</span> a|b</span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">join</span> b</span><br><span class="line">       <span class="keyword">on</span> [<span class="number">1</span>].[<span class="string">'学号'</span>]=[<span class="number">2</span>].[<span class="string">'学号'</span>] <span class="keyword">end</span>; // 注意不同表的字段选取方式</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c:=rand(10,2);</span><br><span class="line">c[:,0]:=(1-&gt;10) div 2;</span><br><span class="line">c[:,1]:=11-&gt;20;</span><br><span class="line">d:=rand(10,2);</span><br><span class="line">d[:,0]:=(1-&gt;10) div 2;</span><br><span class="line">d[:,1]:=1-&gt;10;</span><br><span class="line">e:= <span class="keyword">select</span> [<span class="number">1</span>].*, [<span class="number">2</span>].[<span class="number">1</span>] <span class="keyword">as</span> <span class="number">2</span>, // 防止冲掉同名字段的<span class="number">1</span>列</span><br><span class="line">       thisrowindex(<span class="number">1</span>) <span class="keyword">as</span> <span class="string">'index c'</span>, thisrowindex(<span class="number">2</span>) <span class="keyword">as</span> <span class="string">'index d'</span></span><br><span class="line">       <span class="keyword">from</span> c <span class="keyword">join</span> d</span><br><span class="line">       <span class="keyword">on</span> [<span class="number">1</span>].[<span class="number">0</span>] = [<span class="number">2</span>].[<span class="number">0</span>]</span><br><span class="line">       <span class="keyword">end</span>;</span><br><span class="line">return c|d:|e;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>cross join</code>笛卡尔积</li>
</ol>
<p>不需要<code>on</code>条件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a:=array();</span><br><span class="line">a[0:4,'学号']:=1-&gt;5;</span><br><span class="line">a[0:4,'姓名']:= array('a','b','c','d','e');</span><br><span class="line">b:=array();</span><br><span class="line">b[0:4,'学号']:=1-&gt;5;</span><br><span class="line">b[0:4,'成绩']:=array(90,80,85,95,100);</span><br><span class="line">return <span class="keyword">select</span>[<span class="number">1</span>].*,[<span class="number">2</span>].[<span class="string">'成绩'</span>]</span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">cross</span> <span class="keyword">join</span> b</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><code>left join</code></li>
</ol>
<p>保留左表的全部信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a:=array();</span><br><span class="line">a[0:4,'学号']:=1-&gt;5;</span><br><span class="line">a[0:4,'姓名']:= array('a','b','c','d','e');</span><br><span class="line">b:=array();</span><br><span class="line">b[0:3,'学号']:=1-&gt;4;</span><br><span class="line">b[0:3,'成绩']:=array(90,80,85,95);</span><br><span class="line">return <span class="keyword">select</span> [<span class="number">1</span>].*, [<span class="number">2</span>].[<span class="string">'成绩'</span>]  </span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">left</span> <span class="keyword">join</span> b // 直接<span class="keyword">join</span>会损失e的信息</span><br><span class="line">       <span class="keyword">on</span> [<span class="number">1</span>].[<span class="string">'学号'</span>]=[<span class="number">2</span>].[<span class="string">'学号'</span>] <span class="keyword">end</span>; // 和 a|b 结果是一样的</span><br></pre></td></tr></table></figure>
<ol start="7">
<li><code>right join</code></li>
</ol>
<p>保留右表的全部信息</p>
<ol start="8">
<li><code>join</code>增强语法</li>
</ol>
<p>若表a长度为m,表b的长度为n,则<code>join</code>操作的时间复杂度为<code>O(m*n)</code>,如<code>on [1].[0]+
[2].[0] = [2].[1]</code>.但大多时候只需做普通判断,如<code>on [1].[0]=[2].[0]</code>,这时TSL提供了<br>一种增强语法<code>with ([1].[0] on [2].[0])</code>,该语法可以将该计算的时间复杂度降低到<code>O(m+n)</code>.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a:=rand(10000,2);</span><br><span class="line">b:=rand(1000,2);</span><br><span class="line">a[999,0]:=2;</span><br><span class="line">b[666,0]:=2;</span><br><span class="line">mtic;</span><br><span class="line"><span class="keyword">select</span> [<span class="number">1</span>].* ,[<span class="number">2</span>].[<span class="number">0</span>] <span class="keyword">as</span> <span class="number">2</span></span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">join</span> b</span><br><span class="line">       <span class="keyword">on</span> [<span class="number">1</span>].[<span class="number">0</span>]=[<span class="number">2</span>].[<span class="number">0</span>]</span><br><span class="line">       <span class="keyword">end</span>;</span><br><span class="line">return mtoc; // 1.78s</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">mtic;</span><br><span class="line"><span class="keyword">select</span> [<span class="number">1</span>].* ,[<span class="number">2</span>].[<span class="number">0</span>] <span class="keyword">as</span> <span class="number">2</span></span><br><span class="line">       <span class="keyword">from</span> a <span class="keyword">join</span> b</span><br><span class="line">       <span class="keyword">with</span> ([<span class="number">1</span>].[<span class="number">0</span>] <span class="keyword">on</span> [<span class="number">2</span>].[<span class="number">0</span>])</span><br><span class="line">       <span class="keyword">end</span>;</span><br><span class="line">return mtoc; // 0.01s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>完成指定任务的模型,自己定义的函数可以自己调用<br>函数后必须加<code>()</code>,建议通过参数表增加参数<br>子函数要放在主函数之后。函数参数都是<code>变参</code>,即调用时会改变参数的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Function NULL();</span><br><span class="line">Begin</span><br><span class="line">  r:=array();</span><br><span class="line">  for i := 0 to 99 do</span><br><span class="line">    begin</span><br><span class="line">      r[i,0]:=i;</span><br><span class="line">      r[i,1]:=i+1;</span><br><span class="line">      r[i,&apos;sum&apos;]:=mysum(i,i+1);</span><br><span class="line">    end</span><br><span class="line">  return r;</span><br><span class="line">End;</span><br><span class="line"></span><br><span class="line">function mysum(a,b);  // 注意传入的参数是参数的地址</span><br><span class="line">begin</span><br><span class="line">   return Exp(a)+b^2; // 子函数中return是返回上一层调用</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><code>debugreturn</code>可在任何地方直接将结果返回到客户端,而不是像<code>return</code>一样返回到上一层调用</p>
<p><em>局部变量和全局变量</em></p>
<ol>
<li><p>函数中的变量一般是局部变量,即该变量只在该(子)函数内起作用</p>
</li>
<li><p>全局变量在整个源程序(包括所有的子函数和调用函数)中都有有效的变量,<em>区分大小写</em>。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(&apos;abc&apos;,123);</span><br><span class="line">return GetSysParam(&apos;abc&apos;)+1; // 设置和访问的方法都是不同的</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(&apos;StockID&apos;,&apos;SZ000002&apos;);</span><br><span class="line">// 将StockID这个全局变量的值赋为&apos;SZ000002&apos;</span><br><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">// 效果相同,PN_Stock()返回一个&apos;StockID&apos;字符串,只是为了防止打错</span><br></pre></td></tr></table></figure>
<p>常见系统参数(默认的全局参数):当前股票<code>PN_Stock()</code>,当前时间<code>PN_Date()</code>,周期<code>PN_Cycle()</code>,<br>除权方式<code>PN_Date()</code>,除权基准日<code>PN_RateDay()</code>;</p>
<p>为了避免系统参数在子函数和主函数中的混淆,需要备份并恢复系统参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">oV:=BackUpSystemParameters(); // 备份系统参数</span><br><span class="line">...</span><br><span class="line">RestoreSystemParameters(oV); // 恢复系统参数</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oV := BackUpSystemParameters2(); // 自动回复系统参数,注意放置位置</span><br></pre></td></tr></table></figure>
<h1 id="金融数据的提取"><a href="#金融数据的提取" class="headerlink" title="金融数据的提取"></a>金融数据的提取</h1><ol>
<li><code>base</code>类数据 : 与报告期无关数据,如股票的基本信息,公司名称,所属行业。按F11调出基本面分类浏览表。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">return base(10002);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>Report</code>类数据: 基础财务数据,与报告期相关。</li>
</ol>
<p>特点:一个证券一个报告期一个记录,与四个报告期相关</p>
<p>常见：股票每股收益、三大报表以及财务比率、股票分红配送配股、业绩预测、基金的财务指标、资产配置、持有人结构等。</p>
<p>TSL中报告期是一个8位整数:year+code,其中code有0331,0630,0930,1231,分别表示一季报,中报,三季报和年报。</p>
<p>TSL中每个财务指标都有一个代码(一般为整数),该代码可以从证券数据专家中选取,再点击小人头查看,或按F11进行查阅。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">return report(46002,20200630); // 46002营业收入,20200630报告期为中报</span><br></pre></td></tr></table></figure>
<p><code>ReportOfAll(代码,报告期)</code>:取通过基础财务数据实时计算出来的指标,如净资产收益率=净利率/股东权益</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">v1:=report(46078,20200630);</span><br><span class="line">v2:=report(44140,20200630);</span><br><span class="line">v:=ReportOfAll(9900100,20200630);</span><br><span class="line">return array(v1/v2*100,v);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>季度数据<code>LastQuarterData(报告期,代码,布尔值)</code></li>
</ol>
<p>布尔值默认为0：不取最近报告期<br>例: 万科A今年第三季度营业收入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">return array(LastQuarterData(20200930,46002),</span><br><span class="line">             LastQuarterData(20201231,46002,0),</span><br><span class="line">             LastQuarterData(20201231,46002,1));</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">v1:=report(46002,20200630);</span><br><span class="line">v2:=report(46002,20200930);</span><br><span class="line">v:=LastQuarterData(20200930,46002);</span><br><span class="line">return array(v2-v1,v); // 结果是一样的</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>最近12个月数据(TTM数据)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">v1:=report(46002,20200930);</span><br><span class="line">v2:=LastQuarterData(20191231,46002);</span><br><span class="line">v:=Last12MData(20200930,46002);</span><br><span class="line">return array(v1+v2,v);</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>NewreportDateofEndT2(截止日)</code>根据日期取最新的报告期</li>
</ol>
<p>如在做策略回测时,在一个历史时间点能取得的财务指标有哪些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">return NewreportDateofEndT2(20191015t);</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>提取表格数据:<code>infoarray</code>和<code>infotable</code></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),'SZ000002');</span><br><span class="line">return infoarray(46);</span><br><span class="line">return infoarrayEx(46,20200630);</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> infotable <span class="number">46</span> <span class="keyword">of</span> <span class="string">'SZ000002'</span> <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> infotable <span class="number">46</span> <span class="keyword">of</span> <span class="string">'SZ000002'</span></span><br><span class="line">                    <span class="keyword">where</span> [<span class="string">'截止日'</span>] &gt;= <span class="number">20200630</span> <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> [<span class="string">'StockID'</span>],[<span class="string">'StockName'</span>], sumof([<span class="string">'营业收入'</span>]) <span class="keyword">as</span> <span class="string">'总收入'</span></span><br><span class="line">       <span class="keyword">from</span> infotable <span class="number">46</span> <span class="keyword">of</span> <span class="built_in">array</span>(<span class="string">'SZ000002'</span>,<span class="string">'sh600000'</span>)</span><br><span class="line">       <span class="keyword">where</span> [<span class="string">'截止日'</span>]&gt;=<span class="number">20200331</span></span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'StockID'</span>]</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>例: 取创业板所有股票今年三季报营业收入,按行业分类计算每个行业总营业收入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="keyword">select</span> [<span class="string">'StockID'</span>],[<span class="string">'StockName'</span>],[<span class="string">'营业收入'</span>]</span><br><span class="line">     <span class="keyword">from</span> infotable <span class="number">46</span> <span class="keyword">of</span> GetBK(<span class="string">'创业板'</span>)</span><br><span class="line">     <span class="keyword">where</span> [<span class="string">'截止日'</span>] = <span class="number">20200930</span></span><br><span class="line">     <span class="keyword">end</span>;</span><br><span class="line">for i:=0 to length(a)-1 <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      SetSysParam(PN_Stock(),a[i,<span class="string">'StockID'</span>]);</span><br><span class="line">      a[i,'行业']:=base(10029);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> [<span class="string">'行业'</span>],sumof([<span class="string">'营业收入'</span>])/<span class="number">10</span>^<span class="number">8</span> <span class="keyword">as</span> <span class="string">'总营业收入(亿)'</span></span><br><span class="line">       <span class="keyword">from</span> a</span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'行业'</span>]</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bk := GetBK(&apos;创业板&apos;);</span><br><span class="line">result := array();</span><br><span class="line">for i:=0 to length(bk)-1 do</span><br><span class="line">begin</span><br><span class="line">  stockid := bk[i];</span><br><span class="line">  SetSysParam(PN_Stock(),stockid);</span><br><span class="line">  result[i][&apos;代码&apos;] := bk[i];</span><br><span class="line">  result[i][&apos;行业名称&apos;] := base(10029);</span><br><span class="line">  result[i][&apos;营业收入&apos;] := report(46002,20200930)</span><br><span class="line">end</span><br><span class="line">return select [&apos;行业名称&apos;],countof([&apos;代码&apos;]) as &apos;数量&apos;,</span><br><span class="line">       sumof([&apos;营业收入&apos;]) as &apos;总营业收入&apos;</span><br><span class="line">       from result group by [&apos;行业名称&apos;]</span><br><span class="line">       end;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>财务数据的调整</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">a1:=report(46002,20170630);</span><br><span class="line">SetSysParam(PN_Date(),20171201T);</span><br><span class="line">a2:=report(46002,20170630);</span><br><span class="line">return array(a1,a2); // 根据发报时间不同,财报数据会有调整</span><br></pre></td></tr></table></figure>
<p>设定基本面数据提取的规则,0为最新数据,1为调整前数据,-1在infoarray和infotable中返回调整<br>前和调整后的数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_reportmode(),-1);</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> infotable <span class="number">46</span> <span class="keyword">of</span> <span class="string">'SZ000002'</span></span><br><span class="line">       <span class="keyword">where</span> [<span class="string">'截止日'</span>] = <span class="number">20170630</span></span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>获取历史某日多支股票的财务数据</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">endt := 20201024T;</span><br><span class="line">stks := GetBK(&apos;创业板&apos;);</span><br><span class="line">a:=array();</span><br><span class="line">n:=0;</span><br><span class="line">for i:=0 to length(stks) - 1 do</span><br><span class="line">    Begin</span><br><span class="line">      stockid := stks[i];</span><br><span class="line">      SetSysParam(PN_Stock(),stockid);</span><br><span class="line">      if not IsStockGoMarket(endt) then continue; // 当前股票在endT未上市,则跳过。</span><br><span class="line">      SetSysParam(PN_Date(),endt);</span><br><span class="line">      Rdate:=NewreportDateofEndT2(endt);</span><br><span class="line">      a[n,&apos;代码&apos;] := stockid;</span><br><span class="line">      a[n,&apos;名称&apos;] := StockName(stockid);</span><br><span class="line">      a[n,&apos;日期&apos;] := endt;</span><br><span class="line">      a[n,&apos;报告期&apos;] := Rdate;</span><br><span class="line">      a[n,&apos;每股收益&apos;] := ReportOfAll(9900000,Rdate);</span><br><span class="line">      a[n,&apos;每股收益(季度)&apos;] := LastQuarterData(Rdate,9900000);</span><br><span class="line">      a[n,&apos;每股收益(TTM)&apos;] := Last12MData(Rdate,9900000);</span><br><span class="line">      n := n+1;</span><br><span class="line">    End;</span><br><span class="line">return a;</span><br><span class="line">rdo2 ExportFile(ftXLS(),&apos;&apos;,&apos;C:\Users\username\Desktop\test.xls&apos;,a);</span><br><span class="line">// 需要将天软系统设置调低保护等级,才能将数据保存到本地</span><br></pre></td></tr></table></figure>
<p>输出多个文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stks := getbk(&apos;创业板&apos;);</span><br><span class="line">n:=0;</span><br><span class="line">for i:=0 to length(stks)-1 do</span><br><span class="line">  Begin</span><br><span class="line">    stockid:=stks[i];</span><br><span class="line">    setsysparam(PN_Stock(),stockid);</span><br><span class="line">    b:=infoarray(46);</span><br><span class="line">    rdo2 ExportFile(ftXLS(),&apos;&apos;,&apos;C:\Users\username\Desktop\&apos; + stockid + &apos;.xls&apos;,b);</span><br><span class="line">    // &apos;&apos; + stockid + &apos;&apos; 字符串连接</span><br><span class="line">    n++;</span><br><span class="line">  End</span><br></pre></td></tr></table></figure>
<ol start="9">
<li><code>infotable</code>数据特点: 一个证券有多个记录,公布时间不确定</li>
</ol>
<p>股票:名称变更、大宗交易、融资融券、龙虎榜等</p>
<p>基金:净值、持股明细、行业配置、主要持有人物等</p>
<p>例: 从业绩预增的股票中寻找样本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return <span class="keyword">select</span> drange (<span class="number">0</span> <span class="keyword">to</span> <span class="number">19</span>) * <span class="keyword">from</span> infotable <span class="number">40</span> <span class="keyword">of</span> getbk(<span class="string">'创业板'</span>)</span><br><span class="line">       <span class="keyword">where</span> [<span class="string">'预警类型'</span>] = <span class="string">'预盈'</span> <span class="keyword">and</span> [<span class="string">'公布日'</span>] &gt;= <span class="number">20200630</span>T</span><br><span class="line">       <span class="keyword">and</span> [<span class="string">'比上年同期增长上限(%)'</span>] &gt;<span class="number">60</span></span><br><span class="line">       <span class="keyword">and</span> [<span class="string">'盈利金额上限'</span>] &gt; <span class="number">5000</span></span><br><span class="line">       <span class="keyword">order</span> <span class="keyword">by</span> [<span class="string">'盈利金额上限'</span>] <span class="keyword">desc</span></span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>统计基金的重仓股</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stks := GetBK('华夏');</span><br><span class="line">b := <span class="keyword">select</span> [<span class="string">'代码'</span>],[<span class="string">'名称'</span>],sumof([<span class="string">'市值'</span>]) <span class="keyword">as</span> <span class="string">'总市值'</span>,</span><br><span class="line">       sumof([<span class="string">'数量'</span>]) <span class="keyword">as</span> <span class="string">'总数量'</span>,</span><br><span class="line">       countof([<span class="string">'名称'</span>]) <span class="keyword">as</span> <span class="string">'个数'</span></span><br><span class="line">       <span class="keyword">from</span> infotable <span class="number">318</span> <span class="keyword">of</span> stks</span><br><span class="line">       <span class="keyword">where</span> [<span class="string">'截止日'</span>] = <span class="number">20200930</span></span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> [<span class="string">'代码'</span>]</span><br><span class="line">       <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> b <span class="keyword">order</span> <span class="keyword">by</span> [<span class="string">'总市值'</span>] <span class="keyword">desc</span> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h2 id="基础行情函数"><a href="#基础行情函数" class="headerlink" title="基础行情函数"></a>基础行情函数</h2><p>“名称”,<code>CurrentStockName()</code>,<br><br>“最高价”,<code>high()</code>,<br><br>“收盘价”,<code>system.close()</code>,<br><br>“开盘价”,<code>open()</code>,<br><br>“成交量”,<code>vol()</code>,<br><br>“成交金额”,<code>amount()</code>,<br><br>“最低价”,<code>low()</code>,<br><br>“当前环境时间”,<code>sp_time()</code>:指全局变量下的制定公司的当前交易日,若为节假日或当前股票停牌则返回上一个交易日,若需显示精确时分秒,则需设置相应的周期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_1m()); // 设定返回的时间精确度</span><br><span class="line">return sp_time();</span><br><span class="line">return DatetimeToStr(sp_time());</span><br><span class="line">return DateToStr(sp_time());</span><br><span class="line">return array(open(),close(),vol(),amount(),high(),low());</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_date(),Today()-1+0.99); //</span><br><span class="line">SetSysParam(PN_Cycle(),cy_1m());</span><br><span class="line">return datetostr(sp_time());</span><br></pre></td></tr></table></figure>
<p>这里时间被设置到了昨天的0点,而符合精度的上个交易日为前天的15点。可以在所需取的时间上加0.99,保证取到所需时间<br><br>取时间时要考虑精度情况</p>
<ol>
<li>时间序列函数<code>Nday(整数,字段名1,表达式1,字段名2,表达式2,...)</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">SetSysParam(PN_Date(),20201130T+0.99);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_60m());</span><br><span class="line">return Nday(100,&apos;Date&apos;,DatetimeToStr(sp_time()),&apos;Close&apos;,close(),&apos;Open&apos;,open(),&apos;Diff&apos;,</span><br><span class="line">            close()-open());</span><br><span class="line">// 返回从当前往前一百个交易日的时间序列数据</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>系统参数:复权</li>
</ol>
<p><code>PN_Rate()</code><br>默认为0不复权<br><br>1表示采用交易所数据复权(分红再投资)–策略验证采用这种方式<br><br>2表示采用分红配送数据除权(分红不再投资)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;sz300002&apos;);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_month());</span><br><span class="line">setsysparam(PN_Rate(),1);</span><br><span class="line">return Nday(100,&apos;Date&apos;,datetostr(sp_time()),&apos;close&apos;.close());</span><br></pre></td></tr></table></figure>
<p><code>PN_RateDay()</code>:0表示最后交易日为基准日(默认值,向前复权),<br><br>-1表示以上市日为基准日(向后复权),<br><br>输入其他日期则表示以该日为基准日</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;sz300002&apos;);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_month());</span><br><span class="line">setsysparam(PN_Rate(),1);</span><br><span class="line">SetSysParam(PN_RateDay(),20150227T);</span><br><span class="line">return Nday(100,&apos;Date&apos;,datetostr(sp_time()),&apos;close&apos;.close());</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>Nday3(N,表达式)</code>:取时间序列,但只支持取一列数据,返回为一个一维数组</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">return mean(Nday3(100,close()));</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>区间交易天数<code>tradedays(begt,endt)</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">begt:=20200101T;</span><br><span class="line">endt:=Today();</span><br><span class="line">v1:= tradedays(begt,endt);</span><br><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">v2:= tradedays(begt,endt);</span><br><span class="line">return array(v1,v2); //两日期一样则该股票没有发生过停牌</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>区间市场交易日期列表<code>MarketTradeDayQk(begt,endt)</code></li>
</ol>
<p><code>Ctrl+D</code>可以在结果表格中切换数字和日期格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begt:=20160101T;</span><br><span class="line">endt:=20161231T;</span><br><span class="line">return MarketTradeDayQk(begt,endt);</span><br></pre></td></tr></table></figure>
<h2 id="3个拓展函数"><a href="#3个拓展函数" class="headerlink" title="3个拓展函数"></a>3个拓展函数</h2><ol>
<li><code>ref(表达式Exp,N)</code>:求N<strong>日</strong>前Exp的值,N取负数表示往后取-N<strong>日</strong></li>
</ol>
<p>整个函数返回的是交易日的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Date(),20201130T);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_60m());</span><br><span class="line">return</span><br><span class="line">array(ref(sp_time,1),sp_time()-1);</span><br><span class="line">//sp_time()取决于交易日时间,但-1运算是直接运算的</span><br></pre></td></tr></table></figure>
<p>Nday,复权和涨幅的应用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Date(),20201130T);</span><br><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">SetSysParam(PN_Rate(),1);</span><br><span class="line">//计算和价格相关技术指标需要先复权</span><br><span class="line">return Nday(20,&apos;Date&apos;,DatetimeToStr(sp_time()),&apos;Close&apos;,close(),</span><br><span class="line">            &apos;昨收&apos;,ref(close(),1),</span><br><span class="line">            &apos;昨日涨幅(%)&apos;,StockZf4(ref(sp_time(),1)),</span><br><span class="line">            &apos;昨日涨幅2(%)&apos;,ref(StockZf3(),1),</span><br><span class="line">            &apos;涨幅(%)&apos;,(close()/ref(close(),1)-1)*100,</span><br><span class="line">            &apos;涨幅ZF3(%)&apos;,StockZf3(),</span><br><span class="line">            &apos;1日ZF(%)&apos;,StockZf(sp_time(),sp_time()),</span><br><span class="line">            &apos;指定日涨幅&apos;,StockZf4(sp_time()),</span><br><span class="line">            &apos;两日涨幅ZF(%)&apos;,StockZf(ref(sp_time(),1),sp_time()),</span><br><span class="line">            &apos;两日涨幅2ZF(%)&apos;,StockZf2(2),</span><br><span class="line">            &apos;两日涨幅(%)&apos;,(close()/ref(close(),2)-1)*100);</span><br><span class="line">return array(close(),ref(close(),1),ref(close(),-1));</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>spec(表达式,指定股票代码)</code></li>
</ol>
<p>不改变当前系统参数取表达式的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return array(spec(close(),&apos;SZ000002&apos;),</span><br><span class="line">             close(),GetSysParam(PN_Stock()));</span><br></pre></td></tr></table></figure>
<p><code>specdate(表达式,指定日期)</code></p>
<p>不改变当前系统参数取指定日期表达式的值,<em>表达式有多个数据的情况下,会取指定日期前的多个数据</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 设定了全局日期的情况下</span><br><span class="line">return array(spec(close(),specdate(close(),Today()-1)),</span><br><span class="line">             datetostr(GetSysParam(PN_date())));</span><br></pre></td></tr></table></figure>
<p>例:不改变当前系统参数,取万科再20201130的收盘价</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return specdate(spec(close(),&apos;sz000002&apos;),20201130T);</span><br><span class="line">return spec(specdate(close(),20201130T),&apos;sz000002&apos;);</span><br></pre></td></tr></table></figure>
<p>例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_stock(),&apos;sz000002&apos;);</span><br><span class="line">begt:=20160101T;</span><br><span class="line">endt:=20161231T;</span><br><span class="line">// 返回万科在2016年的所有交易日</span><br><span class="line">return specdate(Nday3(tradedays(begt,endt),sp_time()),endt);</span><br><span class="line">// 返回市场在2016年的所有交易日</span><br><span class="line">return spec(specdate(Nday3(tradedays(begt,endt),sp_time()),endt),</span><br><span class="line">            &apos;SH000001&apos;);</span><br><span class="line">// 上句和下句效果相同</span><br><span class="line">return MarketTradeDayQk(begt,endt);</span><br></pre></td></tr></table></figure>
<p>例: 当前股票为万科,取万科和浦发银行从20201130往前100天的收盘价时间序列并计算它们的收盘价价差</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),&apos;SZ000002&apos;);</span><br><span class="line">SetSysParam(PN_date(),20201130T);</span><br><span class="line">return Nday(100,&apos;日期&apos;,DateToStr(sp_time()),</span><br><span class="line">            &apos;万科收盘价&apos;,close(),</span><br><span class="line">            &apos;浦发收盘价&apos;,spec(close(),&apos;sh600000&apos;),</span><br><span class="line">            &apos;价差&apos;,close()-spec(close(),&apos;sh600000&apos;));</span><br></pre></td></tr></table></figure>
<p>布林线(作业版):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">timeperiod := 20;</span><br><span class="line">k := 2;</span><br><span class="line"></span><br><span class="line">foo := array();</span><br><span class="line">barr := array();</span><br><span class="line">wmaquery := array();</span><br><span class="line">stdev := array();</span><br><span class="line">up := array();</span><br><span class="line">down := array();</span><br><span class="line">result := array();</span><br><span class="line"></span><br><span class="line">for i:=0 to n-1 do</span><br><span class="line">  begin</span><br><span class="line">    foo[length(foo)] := r1[i,&apos;万科收盘价&apos;];</span><br><span class="line">    if length(foo) &gt; timeperiod then</span><br><span class="line">    begin</span><br><span class="line">      foo:=foo[1:length(foo)-1];</span><br><span class="line">    end</span><br><span class="line">    wma := mean(foo);</span><br><span class="line">    wmaquery[i] := wma;</span><br><span class="line">    stdev[i] := sqrt(sum((foo-wma)^2)/length(foo));</span><br><span class="line">    up[i] := wma+k*stdev[i];</span><br><span class="line">    down[i] := wma -k*stdev[i];</span><br><span class="line">  end</span><br><span class="line">  temp := r1[:,&apos;日期&apos;]|r1[:,&apos;万科收盘价&apos;]|wmaquery|up|down;</span><br><span class="line">  result:=select [0] as &apos;日期&apos;, [1] as &apos;close&apos;, [2] as &apos;ma&apos;, [3] as &apos;up&apos;, [4] as</span><br><span class="line">      &apos;down&apos; from temp end;</span><br><span class="line">return result;</span><br></pre></td></tr></table></figure>
<p>BOLL指标的计算公式  </p>
<p>中轨线=N日的移动平均线 N=20<br><br>上轨线=中轨线+两倍的标准差<br><br>下轨线=中轨线-两倍的标准差<br></p>
<p>价差的BOLL线:<br></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(PN_Stock(),'SZ000002');</span><br><span class="line">SetSysParam(PN_date(),20201130T);</span><br><span class="line">SetSysParam(PN_Rate(),1);</span><br><span class="line">a := Nday(200,'日期',DateToStr(sp_time()),</span><br><span class="line">            '万科收盘价',close(),</span><br><span class="line">            '浦发收盘价',spec(close(),'sh600000'),</span><br><span class="line">            '价差',close()-spec(close(),'sh600000')</span><br><span class="line">            );</span><br><span class="line">b:= <span class="keyword">select</span> *,Avgof([<span class="string">'价差'</span>],<span class="literal">true</span>,<span class="number">20</span>) <span class="keyword">as</span> <span class="string">'MA20'</span>,</span><br><span class="line">              stdevof([<span class="string">'价差'</span>],<span class="literal">true</span>,<span class="number">20</span>) <span class="keyword">as</span> <span class="string">'Std20'</span>,</span><br><span class="line">              <span class="keyword">from</span> a</span><br><span class="line">              <span class="keyword">end</span>;</span><br><span class="line">return <span class="keyword">select</span> *,[<span class="string">'MA20'</span>]+<span class="number">2</span>*[<span class="string">'Std20'</span>] <span class="keyword">as</span> <span class="string">'上轨线'</span>,</span><br><span class="line">       [<span class="string">'MA20'</span>]<span class="number">-2</span>*[<span class="string">'Std20'</span>] <span class="keyword">as</span> <span class="string">'下轨线'</span></span><br><span class="line">       <span class="keyword">from</span> b</span><br><span class="line">       <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h2 id="时间序列统计函数"><a href="#时间序列统计函数" class="headerlink" title="时间序列统计函数"></a>时间序列统计函数</h2><ol>
<li><p><code>ma(表达式,N)</code>:计算N日均值</p>
</li>
<li><p><code>ena(表达式,N)</code>:N日指数移动平均</p>
</li>
<li><p><code>SumN(表达式,N)</code>:N日移动求和</p>
</li>
<li><p><code>hhv(表达式,N)</code>: N日的最高值</p>
</li>
<li><p><code>llv(表达式,N)</code>: N日的最低值</p>
</li>
<li><p><code>SP_STD(表达式,N)</code>: 标准差</p>
</li>
<li><p><code>SP_VAR(表达式,N)</code>: 方差</p>
</li>
</ol>
<p>也可以用这些函数来构造布林线</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_stock(),&apos;SZ000002&apos;);</span><br><span class="line">return mean(nday3(100,close())); // 万科100天收盘价格均值</span><br><span class="line">return ma(close(),100); // 万科100天收盘价格均值</span><br><span class="line">return Nday(100,&apos;Date&apos;,DateToStr(sp_time()),&apos;Ma5&apos;,ma(close(),5),</span><br><span class="line">            &apos;Sum5&apos;,SumN(close(),5),&apos;hhv5&apos;,hhv(close(),5));</span><br></pre></td></tr></table></figure>
<ol start="8">
<li><code>count(表达式,N)</code>:统计N天内表达式为真的天数,N为-1表示从上市日第一天开始统计</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_stock(),&apos;SH000001&apos;);</span><br><span class="line">return array(count(isup(),100),count(isdown(),100),count(isequal,100));</span><br><span class="line">// 上涨,下跌,持平天数</span><br></pre></td></tr></table></figure>
<ol start="9">
<li><code>cross(A,B)</code>:布尔量,A线从下面穿越B线时返回1,从A上面向下穿越B时返回-1,否则返回0,<br>与系统参数(股票、日期等)有关</li>
</ol>
<p>万科在指定区间内的均线穿越情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">setsysparam(pn_stock(),&apos;SZ000002&apos;);</span><br><span class="line">end_date := Today();</span><br><span class="line">beg_date := Today()-90; //end_date 前推一个</span><br><span class="line">r := array();</span><br><span class="line">i := 0;</span><br><span class="line">for d := end_date downto beg_date do</span><br><span class="line">  begin</span><br><span class="line">    if not istradeday(d) then continue;</span><br><span class="line">    setsysparam(pn_date(),d);</span><br><span class="line">    r[i][&apos;date&apos;] := datetostr(d);</span><br><span class="line">    r[i][&apos;close&apos;] := close();</span><br><span class="line">    r[i][&apos;Ma5&apos;] := ma(close(),5);</span><br><span class="line">    if isup() then r[i][&apos;ud_state&apos;]:=&apos;涨&apos;;</span><br><span class="line">    if isdown() then r[i][&apos;ud_state&apos;]:=&apos;跌&apos;;</span><br><span class="line">    if isequal() then r[i][&apos;ud_state&apos;]:=&apos;平盘&apos;;</span><br><span class="line">    case cross(close(),ma(close(),5)) of</span><br><span class="line">    1:begin</span><br><span class="line">       r[i][&apos;cross_state&apos;] := &apos;突破5日均线&apos;;</span><br><span class="line">      end</span><br><span class="line">    -1:begin</span><br><span class="line">       r[i][&apos;cross_state&apos;] := &apos;跌破5日均线&apos;;</span><br><span class="line">      end</span><br><span class="line">    0:begin</span><br><span class="line">       r[i][&apos;cross_state&apos;] := &apos;&apos;;</span><br><span class="line">      end</span><br><span class="line">    end;</span><br><span class="line">    i++;</span><br><span class="line">  end;</span><br><span class="line">return r;</span><br></pre></td></tr></table></figure>
<p><strong>ma,SP_STD,sp_var等是对于行情函数数据进行时间序列分析的统计函数</strong><br><strong>mean,stddev,variance等是对一般数据(数组矩阵等)处理的统计函数</strong><br><strong>avgof,stdevof,varof等是与select语句结合使用的聚集函数</strong><br><strong>以上三者不可以混用</strong></p>
<h2 id="表达式前置符"><a href="#表达式前置符" class="headerlink" title="表达式前置符"></a>表达式前置符</h2><p><code>exp:=@(...)</code>, 用<code>eval(exp)</code>进行调用,使代码简洁一点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pfclose:=@(spec(close(),&apos;sh600000&apos;)); // 自定义一个表达式</span><br><span class="line">return eval(pfclose);</span><br><span class="line">return Nday(200,&apos;日期&apos;,DateToStr(sp_time()),</span><br><span class="line">            &apos;万科收盘价&apos;,close(),</span><br><span class="line">            &apos;浦发收盘价&apos;,eval(pfclose),</span><br><span class="line">            &apos;价差&apos;,close()-spec(close(),&apos;sh600000&apos;)</span><br><span class="line">            );</span><br></pre></td></tr></table></figure>
<p>价差BOLL线:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pfclose := @(spec(close(),&apos;sh510500&apos;));</span><br><span class="line">mydiff := @(close()-spec(close(),&apos;sh510500&apos;));</span><br><span class="line">myma := @(ma(eval(mydiff),20));</span><br><span class="line">mystd := @(SP_STD(eval(mydiff),20));</span><br><span class="line">upline := @(eval(myma)+2*eval(mystd));</span><br><span class="line">downline := @(eval(myma)-2*eval(mystd));</span><br><span class="line"></span><br><span class="line">return Nday(300,&apos;日期&apos;,DateToStr(sp_time()),</span><br><span class="line">            &apos;万科收盘价&apos;,close(),</span><br><span class="line">            &apos;浦发收盘价&apos;,eval(pfclose),</span><br><span class="line">            &apos;价差&apos;,eval(mydiff),</span><br><span class="line">            &apos;Nma20&apos;,eval(myma),</span><br><span class="line">            &apos;Nstd20&apos;,eval(mystd),</span><br><span class="line">            &apos;上轨线&apos;,eval(upline),</span><br><span class="line">            &apos;下轨线&apos;,eval(downline),</span><br><span class="line">            &apos;上穿&apos;,cross(eval(mydiff),eval(upline)),</span><br><span class="line">            &apos;下穿&apos;,cross(eval(mydiff),eval(downline)));</span><br></pre></td></tr></table></figure>
<h2 id="‘-’的另一个用法-多级表头"><a href="#‘-’的另一个用法-多级表头" class="headerlink" title="‘@’的另一个用法:多级表头"></a>‘@’的另一个用法:多级表头</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_stock(),&apos;SZ000002&apos;);</span><br><span class="line">return Nday(60,&apos;Date&apos;,DateToStr(sp_time()),</span><br><span class="line">           StockName(&apos;SZ000002&apos;)+&apos;@收盘价&apos;,close(),</span><br><span class="line">           StockName(&apos;SZ000002&apos;)+&apos;@最高价&apos;,high(),</span><br><span class="line">           StockName(&apos;SZ000002&apos;)+&apos;@成交量&apos;,vol(),</span><br><span class="line">           StockName(&apos;SH600000&apos;)+&apos;@收盘价&apos;,spec(close(),&apos;SH600000&apos;),</span><br><span class="line">           StockName(&apos;SH600000&apos;)+&apos;@最高价&apos;,spec(high(),&apos;SH600000&apos;),</span><br><span class="line">           StockName(&apos;SH600000&apos;)+&apos;@成交量&apos;,spec(vol(),&apos;SH600000&apos;));</span><br></pre></td></tr></table></figure>
<h2 id="高频数据的提取"><a href="#高频数据的提取" class="headerlink" title="高频数据的提取"></a>高频数据的提取</h2><ol>
<li>时间和周期的设置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetSysParam(pn_stock(),&apos;sz000002&apos;);</span><br><span class="line">SetSysParam(PN_date(),20201209T+0.99);</span><br><span class="line">SetSysParam(PN_Cycle(),cy_60m());</span><br><span class="line">return Nday(60,&apos;date&apos;,DatetimeToStr(sp_time()),&apos;Close&apos;,close());</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>存放高频数据的两张表</li>
</ol>
<p><code>markettable</code>:分时数据,高频,根据tradetable处理后的数据,需要设置周期<br><br><code>tradetable</code>:交易明细,超高频,沪深level 1高频数据,tick数据<br><br>上交所5秒一笔,深交所3秒一笔</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begt:=20201209T;</span><br><span class="line">return <span class="keyword">select</span> * <span class="keyword">from</span> tradetable datekey begt <span class="keyword">to</span> begt+<span class="number">0.99</span></span><br><span class="line">       <span class="keyword">of</span> <span class="string">'sz000002'</span> <span class="keyword">end</span>; // tradetable和周期无关</span><br></pre></td></tr></table></figure>
<p>作业: 进行行业资金流向分析(最多最少)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Function NULL(BkName,EndT);</span><br><span class="line">Begin</span><br><span class="line">   StockArr:=GetBK(BkName);</span><br><span class="line">   r:=array();</span><br><span class="line">   n:=0;</span><br><span class="line">   for nI:=0 to length(StockArr)-1 do</span><br><span class="line">   begin</span><br><span class="line">      StockId:=StockArr[nI];</span><br><span class="line">      SetSysParam(PN_Stock(),StockId);</span><br><span class="line">      SetSysParam(PN_Date(),EndT);</span><br><span class="line">         //没有上市</span><br><span class="line">      if not IsStockGoMarket(EndT) then continue;</span><br><span class="line">         //没有交易</span><br><span class="line">      if not istradeday(EndT) then continue;</span><br><span class="line">      r[n][&apos;代码&apos;]:=StockId;</span><br><span class="line">         //r[n][&apos;名称&apos;]:=StockName(StockId);</span><br><span class="line">      r[n][&apos;日期&apos;]:=datetostr(EndT);</span><br><span class="line"></span><br><span class="line">         //主买量-当日累计</span><br><span class="line">      r[n][&apos;主买量&apos;]:=td_sectional_buy_vol();</span><br><span class="line">         //主卖量-当日累计</span><br><span class="line">      r[n][&apos;主卖量&apos;]:=td_sectional_sale_vol();</span><br><span class="line">         //主买金额-当日累计</span><br><span class="line">      r[n][&apos;主买金额&apos;]:=td_sectional_buy_amount();</span><br><span class="line">         //主卖金额-当日累计</span><br><span class="line">      r[n][&apos;主卖金额&apos;]:=td_sectional_sale_amount();</span><br><span class="line">         //资金流向-当日累计</span><br><span class="line">      r[n][&apos;资金流向&apos;]:=r[n][&apos;主买金额&apos;]-r[n][&apos;主卖金额&apos;];</span><br><span class="line">      n++;</span><br><span class="line">   end;</span><br><span class="line">   return r;</span><br><span class="line"></span><br><span class="line">End;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/笔记/" rel="tag"># 笔记</a>
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/25/trans-eco-virus_1/" rel="next" title="冠状病毒：又一次">
                <i class="fa fa-chevron-left"></i> 冠状病毒：又一次
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/02/pythondaily/" rel="prev" title="python批量行处理的小应用">
                python批量行处理的小应用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="wjqsteam" />
            
              <p class="site-author-name" itemprop="name">wjqsteam</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TSL语言基础"><span class="nav-number">1.</span> <span class="nav-text">TSL语言基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据类型"><span class="nav-number">1.1.</span> <span class="nav-text">数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础类型"><span class="nav-number">1.1.1.</span> <span class="nav-text">基础类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊类型"><span class="nav-number">1.1.2.</span> <span class="nav-text">特殊类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#没有布尔类型"><span class="nav-number">1.1.3.</span> <span class="nav-text">没有布尔类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数组"><span class="nav-number">1.1.4.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日期类型——用浮点数表示日期和时间"><span class="nav-number">1.1.5.</span> <span class="nav-text">日期类型——用浮点数表示日期和时间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运算符"><span class="nav-number">1.2.</span> <span class="nav-text">运算符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关系运算"><span class="nav-number">1.3.</span> <span class="nav-text">关系运算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#逻辑运算"><span class="nav-number">1.4.</span> <span class="nav-text">逻辑运算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运算优先级"><span class="nav-number">1.5.</span> <span class="nav-text">运算优先级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常量和变量：变量不需要预先定义-变量不区分大小写"><span class="nav-number">1.6.</span> <span class="nav-text">常量和变量：变量不需要预先定义,变量不区分大小写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#条件语句"><span class="nav-number">1.7.</span> <span class="nav-text">条件语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套"><span class="nav-number">1.7.1.</span> <span class="nav-text">嵌套</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#循环"><span class="nav-number">1.8.</span> <span class="nav-text">循环</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#for循环"><span class="nav-number">1.8.1.</span> <span class="nav-text">for循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#while循环"><span class="nav-number">1.8.2.</span> <span class="nav-text">while循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#repeat循环"><span class="nav-number">1.8.3.</span> <span class="nav-text">repeat循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Case多条件分支"><span class="nav-number">1.9.</span> <span class="nav-text">Case多条件分支</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#矩阵-二维数组"><span class="nav-number">1.10.</span> <span class="nav-text">矩阵(二维数组)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#矩阵算符"><span class="nav-number">1.10.1.</span> <span class="nav-text">矩阵算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取子矩阵-切片"><span class="nav-number">1.10.2.</span> <span class="nav-text">取子矩阵(切片)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关函数"><span class="nav-number">1.10.3.</span> <span class="nav-text">相关函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#矩阵的查找和遍历"><span class="nav-number">1.10.4.</span> <span class="nav-text">矩阵的查找和遍历</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指标转换reindex-数组-dim1-dim2"><span class="nav-number">1.10.5.</span> <span class="nav-text">指标转换reindex(数组,dim1,dim2,...)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除矩阵行列的函数"><span class="nav-number">1.10.6.</span> <span class="nav-text">删除矩阵行列的函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集合运算"><span class="nav-number">1.10.7.</span> <span class="nav-text">集合运算</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数对于异常输入的处理"><span class="nav-number">1.11.</span> <span class="nav-text">函数对于异常输入的处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#统计函数"><span class="nav-number">1.12.</span> <span class="nav-text">统计函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL-结构化查询语言-Structual-Query-Language"><span class="nav-number">2.</span> <span class="nav-text">SQL-结构化查询语言(Structual Query Language)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#聚集函数"><span class="nav-number">2.1.</span> <span class="nav-text">聚集函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类SQL语法的其他操作"><span class="nav-number">2.2.</span> <span class="nav-text">类SQL语法的其他操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#函数"><span class="nav-number">3.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#金融数据的提取"><span class="nav-number">4.</span> <span class="nav-text">金融数据的提取</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础行情函数"><span class="nav-number">4.1.</span> <span class="nav-text">基础行情函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3个拓展函数"><span class="nav-number">4.2.</span> <span class="nav-text">3个拓展函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时间序列统计函数"><span class="nav-number">4.3.</span> <span class="nav-text">时间序列统计函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表达式前置符"><span class="nav-number">4.4.</span> <span class="nav-text">表达式前置符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#‘-’的另一个用法-多级表头"><span class="nav-number">4.5.</span> <span class="nav-text">‘@’的另一个用法:多级表头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高频数据的提取"><span class="nav-number">4.6.</span> <span class="nav-text">高频数据的提取</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wjqsteam</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.4.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
